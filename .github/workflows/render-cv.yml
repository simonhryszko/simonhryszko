name: Render CV

on:
  push:
    branches: [ main, master ]
  create:
    tags:
      - '*'

jobs:
  detect-files:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      has_files: ${{ steps.set-matrix.outputs.has_files }}
    steps:
      - uses: actions/checkout@v4
      - name: Get YAML files
        id: set-matrix
        run: |
          # Find all YAML files in resume directory
          files=$(find resume -name "*.yaml" -o -name "*.yml" 2>/dev/null || true)

          if [ -z "$files" ]; then
            echo "No YAML files found in resume/ directory"
            echo "matrix=[]" >> $GITHUB_OUTPUT
            echo "has_files=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Convert to JSON matrix format
          matrix=$(echo "$files" | jq -R -s 'split("\n") | map(select(length > 0))' | jq -c '.')
          echo "matrix=${matrix}" >> $GITHUB_OUTPUT
          echo "has_files=true" >> $GITHUB_OUTPUT

          echo "Found CV files:"
          echo "$files"

  render:
    needs: detect-files
    runs-on: ubuntu-latest
    if: needs.detect-files.outputs.has_files == 'true'
    strategy:
      matrix:
        file: ${{ fromJson(needs.detect-files.outputs.matrix) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install RenderCV
        run: |
          pip install "rendercv[full]"

      - name: Get filename without extension
        id: filename
        run: |
          filename=$(basename "${{ matrix.file }}" .yaml)
          filename=$(basename "$filename" .yml)
          echo "original_name=${filename}" >> $GITHUB_OUTPUT
          echo "Processing file: ${{ matrix.file }} -> ${filename}"

      - name: Render CV
        run: |
          # Create output directory
          mkdir -p rendercv_output

          # Render the CV
          rendercv render "${{ matrix.file }}" || {
            echo "Failed to render ${{ matrix.file }}"
            exit 1
          }

      - name: Organize output files
        run: |
          filename="${{ steps.filename.outputs.original_name }}"

          # Move output files to organized location
          if [ -f "${filename}.pdf" ]; then
            mv "${filename}.pdf" "rendercv_output/${filename}.pdf"
          fi
          if [ -f "${filename}.html" ]; then
            mv "${filename}.html" "rendercv_output/${filename}.html"
          fi
          if [ -f "${filename}.md" ]; then
            mv "${filename}.md" "rendercv_output/${filename}.md"
          fi
          if [ -f "${filename}_1.png" ]; then
            mv "${filename}_1.png" "rendercv_output/${filename}_1.png"
          fi
          if [ -f "${filename}.typ" ]; then
            mv "${filename}.typ" "rendercv_output/${filename}.typ"
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: cv-${{ steps.filename.outputs.original_name }}
          path: rendercv_output/
          retention-days: 30

      - name: List generated files
        run: |
          echo "Generated files for ${{ steps.filename.outputs.original_name }}:"
          ls -la rendercv_output/ || true
